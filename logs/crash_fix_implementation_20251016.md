# è®¿é—®è¿è§„å´©æºƒä¿®å¤å®æ–½æŠ¥å‘Š

## é”™è¯¯ä»£ç 
**0xC0000005 (ACCESS_VIOLATION)** - å¤šçº¿ç¨‹è®¿é—®å†²çªå¯¼è‡´çš„è®¿é—®è¿è§„

## ä¿®å¤å®æ–½ âœ…

### 1. CameraConfig/CamOperation_class.py

#### æ·»åŠ é‡ç½®æ ‡å¿—
```python
# ç¬¬ 167 è¡Œ
self.is_resetting = False  # ğŸš© æ ‡è®°æ˜¯å¦æ­£åœ¨é‡ç½®ç¼“å†²åŒº
```

**ä½œç”¨**: é€šçŸ¥å…¶ä»–çº¿ç¨‹ç¼“å†²åŒºæ­£åœ¨é‡ç½®ï¼Œé¿å…å¹¶å‘è®¿é—®

#### ä¼˜åŒ–ç¼“å†²åŒºé‡ç½®æµç¨‹
```python
if ret == 0x80000007:
    # 1. è®¾ç½®é‡ç½®æ ‡å¿—
    self.is_resetting = True
    logger.log("[INFO] å·²è®¾ç½®é‡ç½®æ ‡å¿—ï¼Œç­‰å¾…å…¶ä»–æ“ä½œå®Œæˆ...")
    
    # 2. ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆï¼ˆ0.5ç§’ï¼‰
    time.sleep(0.5)
    
    # 3. åœ¨é”å†…å®‰å…¨é‡ç½®
    with self.buf_lock:
        # æ¸…ç†å’Œé‡æ–°åˆ†é…
        ...
    
    # 4. é‡ç½®åç­‰å¾…ï¼ˆ0.2ç§’ï¼‰
    time.sleep(0.2)
    
    # 5. æ¸…é™¤é‡ç½®æ ‡å¿—
    self.is_resetting = False
    logger.log("[INFO] ç¼“å†²åŒºé‡ç½®å®Œæˆï¼Œæ¢å¤æ­£å¸¸æ“ä½œ")
```

**æ”¹è¿›ç‚¹**:
- âœ… è®¾ç½®æ ‡å¿—é˜²æ­¢æ–°çš„è®¿é—®
- âœ… å¢åŠ ç­‰å¾…æ—¶é—´ï¼ˆ0.5s â†’ ä¿è¯å…¶ä»–æ“ä½œå®Œæˆï¼‰
- âœ… é‡ç½®åç­‰å¾…ï¼ˆ0.2s â†’ ä¿è¯çŠ¶æ€ç¨³å®šï¼‰
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•æ¯ä¸ªæ­¥éª¤

### 2. MainPage.py - update_frame()

#### æ·»åŠ é‡ç½®æ£€æŸ¥
```python
def update_frame(self):
    # ğŸš© æ£€æŸ¥æ˜¯å¦æ­£åœ¨é‡ç½®
    if hasattr(MainPage1.obj_cam_operation, 'is_resetting') and \
       MainPage1.obj_cam_operation.is_resetting:
        return None  # ç­‰å¾…é‡ç½®å®Œæˆ
```

#### å¢å¼ºç¼“å†²åŒºéªŒè¯
```python
with MainPage1.obj_cam_operation.buf_lock:
    st_info = MainPage1.obj_cam_operation.st_frame_info
    buf = MainPage1.obj_cam_operation.buf_save_image
    
    # âœ… å…¨é¢éªŒè¯
    if not st_info or st_info.nFrameLen <= 0 or buf is None:
        return None
    if st_info.nWidth <= 0 or st_info.nHeight <= 0:
        return None
    
    # âœ… å¼‚å¸¸æ•è·
    try:
        data = np.frombuffer(buf, ...).copy()
    except Exception as e:
        print(f"è¯»å–å¸§ç¼“å†²åŒºå¤±è´¥: {e}")
        return None
```

**æ”¹è¿›ç‚¹**:
- âœ… é‡ç½®æœŸé—´ç›´æ¥è¿”å› None
- âœ… éªŒè¯ buf ä¸ä¸º None
- âœ… éªŒè¯å®½é«˜æœ‰æ•ˆæ€§
- âœ… frombuffer å¼‚å¸¸æ•è·
- âœ… è¿”å› None è€Œä¸æ˜¯ raiseï¼ˆæ›´å®‰å…¨ï¼‰

### 3. MainPage.py - match_and_move()

#### æ·»åŠ å®‰å…¨æ£€æŸ¥
```python
def match_and_move(self):
    # ğŸš© æ£€æŸ¥é‡ç½®çŠ¶æ€
    if hasattr(MainPage1.obj_cam_operation, 'is_resetting') and \
       MainPage1.obj_cam_operation.is_resetting:
        return False  # ç­‰å¾…é‡ç½®å®Œæˆ
    
    # è·å–å¸§
    video = self.update_frame()
    
    # âœ… éªŒè¯å¸§æœ‰æ•ˆæ€§
    if video is None:
        return False
```

**æ”¹è¿›ç‚¹**:
- âœ… é‡ç½®æœŸé—´ä¸è¿›è¡Œæ¨¡æ¿åŒ¹é…
- âœ… æ£€æŸ¥ video æ˜¯å¦ä¸º None
- âœ… è¿”å› False è¡¨ç¤ºåŒ¹é…å¤±è´¥ï¼ˆè€Œä¸æ˜¯å´©æºƒï¼‰

## ä¿®å¤æœºåˆ¶

### æ—¶åºå›¾
```
ç¼“å†²åŒºé”™è¯¯å‘ç”Ÿ (0x80000007)
    â†“
è®¾ç½® is_resetting = True
    â†“
ç­‰å¾… 0.5 ç§’ï¼ˆå…¶ä»–çº¿ç¨‹å®Œæˆå½“å‰æ“ä½œï¼‰
    â†“
å…¶ä»–çº¿ç¨‹æ£€æµ‹åˆ° is_resetting
    â†“
    â”œâ”€ update_frame() â†’ return None
    â””â”€ match_and_move() â†’ return False
    â†“
è·å– buf_lock
    â†“
æ¸…ç†ç¼“å†²åŒºï¼ˆè®¾ç½®ä¸º Noneï¼‰
    â†“
é‡æ–°åˆ†é…ç¼“å†²åŒº
    â†“
é‡Šæ”¾ buf_lock
    â†“
ç­‰å¾… 0.2 ç§’ï¼ˆç¨³å®šçŠ¶æ€ï¼‰
    â†“
è®¾ç½® is_resetting = False
    â†“
æ¢å¤æ­£å¸¸æ“ä½œ
```

### é˜²æŠ¤å±‚æ¬¡

#### ç¬¬ä¸€å±‚ï¼šé‡ç½®æ ‡å¿—
```python
if is_resetting:
    return None/False
```
**ä½œç”¨**: é˜»æ­¢æ–°çš„è®¿é—®è¯·æ±‚

#### ç¬¬äºŒå±‚ï¼šç¼“å†²åŒºéªŒè¯
```python
if buf is None or st_info.nFrameLen <= 0:
    return None
```
**ä½œç”¨**: éªŒè¯æ•°æ®æœ‰æ•ˆæ€§

#### ç¬¬ä¸‰å±‚ï¼šå¼‚å¸¸æ•è·
```python
try:
    data = np.frombuffer(buf, ...)
except Exception:
    return None
```
**ä½œç”¨**: æ•è·æ„å¤–é”™è¯¯

#### ç¬¬å››å±‚ï¼šé”ä¿æŠ¤
```python
with buf_lock:
    # è®¿é—®ç¼“å†²åŒº
```
**ä½œç”¨**: é˜²æ­¢å¹¶å‘å†™å…¥

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯
1. âœ… æ­£å¸¸è¿è¡Œ + ç¼“å†²åŒºé”™è¯¯
2. âœ… è‡ªåŠ¨æµ‹è¯• + ç¼“å†²åŒºé”™è¯¯
3. âœ… å¤šçº¿ç¨‹æ“ä½œï¼ˆç§»åŠ¨ + å¯¹é½ + ç›¸æœºï¼‰
4. âœ… é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§

### é¢„æœŸè¡Œä¸º

#### ç¼“å†²åŒºé”™è¯¯å‘ç”Ÿæ—¶
```
[WARNING] æ£€æµ‹åˆ°ç¼“å†²åŒºé”™è¯¯(0x80000007)
[INFO] å·²è®¾ç½®é‡ç½®æ ‡å¿—ï¼Œç­‰å¾…å…¶ä»–æ“ä½œå®Œæˆ...
[INFO] å¼€å§‹æ¸…ç†ç¼“å†²åŒº...
[OK] ç¼“å†²åŒºé‡ç½®æˆåŠŸ
[INFO] ç¼“å†²åŒºé‡ç½®å®Œæˆï¼Œæ¢å¤æ­£å¸¸æ“ä½œ
```

#### å…¶ä»–çº¿ç¨‹çš„è¡Œä¸º
- `update_frame()` è¿”å› None
- `match_and_move()` è¿”å› False
- ä¸ä¼šå´©æºƒï¼Œè€Œæ˜¯ä¼˜é›…åœ°è·³è¿‡å½“å‰æ“ä½œ

### ç›‘æ§æŒ‡æ ‡
- âœ… ä¸å†å‡ºç° 0xC0000005 é”™è¯¯
- âœ… æ—¥å¿—ä¸­æœ‰è¯¦ç»†çš„é‡ç½®è®°å½•
- âœ… å†…å­˜ä½¿ç”¨ç¨³å®š
- âœ… çº¿ç¨‹æ•°é‡ç¨³å®š

## ä¸ä¹‹å‰ä¿®å¤çš„å…³ç³»

### å·²æœ‰çš„ä¿æŠ¤æœºåˆ¶
1. âœ… `camera_lock` - ä¿æŠ¤ç›¸æœº SDK è°ƒç”¨
2. âœ… `buf_lock` - ä¿æŠ¤ç¼“å†²åŒºè¯»å†™
3. âœ… ç¼“å†²åŒºé”™è¯¯æ¢å¤ï¼ˆ0x80000007ï¼‰

### æ–°å¢çš„ä¿æŠ¤æœºåˆ¶
4. âœ… `is_resetting` - é˜²æ­¢é‡ç½®æœŸé—´è®¿é—®
5. âœ… å¢å¼ºçš„ç¼“å†²åŒºéªŒè¯
6. âœ… æ›´é•¿çš„ç­‰å¾…æ—¶é—´
7. âœ… æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•

### ååŒå·¥ä½œ
```
camera_lock          â†’ åºåˆ—åŒ–ç›¸æœºæ“ä½œ
    â†“
buf_lock            â†’ ä¿æŠ¤ç¼“å†²åŒºè®¿é—®
    â†“
is_resetting        â†’ é˜²æ­¢é‡ç½®æœŸé—´è®¿é—®
    â†“
ç¼“å†²åŒºéªŒè¯          â†’ éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
    â†“
å¼‚å¸¸æ•è·            â†’ æœ€åé˜²çº¿
```

## ä»£ç ä¿®æ”¹æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶
1. âœ… `CameraConfig/CamOperation_class.py`
   - æ·»åŠ  `is_resetting` æ ‡å¿—
   - ä¼˜åŒ–ç¼“å†²åŒºé‡ç½®æµç¨‹
   - å¢åŠ è¯¦ç»†æ—¥å¿—

2. âœ… `MainPage.py`
   - `update_frame()`: æ·»åŠ é‡ç½®æ£€æŸ¥ + å¢å¼ºéªŒè¯
   - `match_and_move()`: æ·»åŠ é‡ç½®æ£€æŸ¥ + å¸§éªŒè¯

### ä¿®æ”¹çš„è¡Œæ•°
- CamOperation_class.py: ~20 è¡Œ
- MainPage.py: ~15 è¡Œ
- æ€»è®¡: ~35 è¡Œ

### å‘åå…¼å®¹æ€§
- âœ… ä½¿ç”¨ `hasattr()` æ£€æŸ¥ï¼Œå…¼å®¹æ—§ç‰ˆæœ¬
- âœ… ä¸æ”¹å˜å¤–éƒ¨æ¥å£
- âœ… é»˜è®¤è¡Œä¸ºä¿æŒä¸å˜

## æ€§èƒ½å½±å“

### æ­£å¸¸æƒ…å†µï¼ˆæ— é”™è¯¯ï¼‰
- å½±å“: **æå°**
- é¢å¤–å¼€é”€: ä¸€æ¬¡å¸ƒå°”å€¼æ£€æŸ¥ï¼ˆ`if is_resetting`ï¼‰

### ç¼“å†²åŒºé”™è¯¯å‘ç”Ÿæ—¶
- å»¶è¿Ÿ: **0.8 ç§’** (0.5s ç­‰å¾… + 0.1s é‡ç½® + 0.2s ç¨³å®š)
- å½±å“: **å¯æ¥å—**
- é¢‘ç‡: **ç½•è§** (ä»…åœ¨ç¡¬ä»¶é—®é¢˜æ—¶)

### å…¶ä»–çº¿ç¨‹
- é‡ç½®æœŸé—´: è·³è¿‡ 1-2 å¸§ï¼ˆçº¦ 0.06s Ã— 2 = 0.12sï¼‰
- ç”¨æˆ·æ„ŸçŸ¥: **æ— æ˜æ˜¾å½±å“**

## åç»­å»ºè®®

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰
1. âœ… éƒ¨ç½²ä¿®å¤ä»£ç 
2. âœ… è§‚å¯Ÿå´©æºƒæ˜¯å¦æ¶ˆå¤±
3. âœ… æ£€æŸ¥æ—¥å¿—ä¸­é‡ç½®è®°å½•

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰
1. ç»Ÿè®¡ç¼“å†²åŒºé”™è¯¯é¢‘ç‡
2. å¦‚æœé¢‘ç¹ï¼Œè€ƒè™‘å¢åŠ ç¼“å†²åŒºå¤§å°
3. ä¼˜åŒ–ç›¸æœºå‚æ•°ï¼ˆå¸§ç‡ã€åˆ†è¾¨ç‡ï¼‰

### é•¿æœŸ
1. è€ƒè™‘å‡çº§ç›¸æœº SDK
2. è€ƒè™‘ç¡¬ä»¶å‡çº§
3. ä¼˜åŒ–çº¿ç¨‹æ¶æ„ï¼ˆå‡å°‘å¹¶å‘åº¦ï¼‰

## æ€»ç»“

### é—®é¢˜
**0xC0000005**: å¤šçº¿ç¨‹åœ¨ç¼“å†²åŒºé‡ç½®æœŸé—´è®¿é—®ç›¸æœºç¼“å†²åŒº

### æ ¹å› 
- ç¼ºå°‘é‡ç½®æ ‡å¿—
- ç­‰å¾…æ—¶é—´ä¸è¶³
- ç¼“å†²åŒºéªŒè¯ä¸å…¨é¢

### ä¿®å¤
1. âœ… æ·»åŠ  `is_resetting` æ ‡å¿—
2. âœ… å¢åŠ ç­‰å¾…æ—¶é—´ï¼ˆ0.8ç§’ï¼‰
3. âœ… å¢å¼ºç¼“å†²åŒºéªŒè¯
4. âœ… æ·»åŠ å¼‚å¸¸æ•è·
5. âœ… è¯¦ç»†æ—¥å¿—è®°å½•

### æ•ˆæœ
- ğŸ¯ æ¶ˆé™¤ ACCESS_VIOLATION å´©æºƒ
- ğŸ¯ æé«˜ç³»ç»Ÿç¨³å®šæ€§
- ğŸ¯ ç¼“å†²åŒºé”™è¯¯å®‰å…¨æ¢å¤
- ğŸ¯ ä¸å½±å“æ­£å¸¸æ€§èƒ½

---
**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-16 18:25
**ä¿®æ”¹æ–‡ä»¶æ•°**: 2 ä¸ª
**ä¿®æ”¹ä»£ç è¡Œ**: 35 è¡Œ
**æµ‹è¯•çŠ¶æ€**: å¾…éªŒè¯
**é¢„æœŸæ•ˆæœ**: æ¶ˆé™¤ 0xC0000005 å´©æºƒ
